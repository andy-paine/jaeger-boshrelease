<%-
  require 'yaml'
  flags = []

  # Collector directly mapped variables
  ['collector.grpc-port', 'collector.http-port', 'collector.num-workers', 'collector.port', 'collector.queue-size', 'collector.queue-size-memory', 'collector.zipkin.http-port' ].each do |property|
    flags << "--#{property}=#{p(property)}"
  end

  # Collector formatted collections
  flags << "--collector.zipkin.allowed-headers='#{p('collector.zipkin.allowed-headers').join(',')}'"
  flags << "--collector.zipkin.allowed-origins='#{p('collector.zipkin.allowed-origins').join(',')}'"
  if_p('collector.tags') do |tags|
    formatted_tags = tags.map { |key,value| "#{key}=#{value}" }.join(',')
    flags << "--collector.tags='#{formatted_tags}'"
  end

  # Collector TLS configuration
  if_p('collector.grpc.tls.private_key', 'collector.grpc.tls.certificate') do |key, cert|
    flags << '--collector.grpc.tls.enabled=true'
    flags << '--collector.grpc.tls.key=/var/vcap/jobs/jaeger-all-in-one/tls/grpc.key'
    flags << '--collector.grpc.tls.cert=/var/vcap/jobs/jaeger-all-in-one/tls/grpc.crt'
  end.else do
    flags << '--collector.grpc.tls.enabled=false'
  end
  if_p('collector.grpc.tls.client-ca') do |_|
    flags << '--collector.grpc.tls.client-ca=/var/vcap/jobs/jaeger-all-in-one/tls/grpc-client-ca.crt'
  end

  # Storage configuration
  case p('span_storage_type')
  when 'memory'
  when 'badger'
    flags << "--badger.ephemeral=false"
    flags << "--badger.directory-key=/var/vcap/store/jaeger-all-in-one/keys"
    flags << "--badger.directory-value=/var/vcap/store/jaeger-all-in-one/values"
  else
    raise "Only ['memory', 'badger'] are supported values for span_storage_type, not: #{p('span_storage_type')}"
  end
-%>
processes:
  - name: jaeger-all-in-one
    executable: /var/vcap/packages/jaeger/jaeger-all-in-one
    env:
      SPAN_STORAGE_TYPE: <%= p('span_storage_type') %>
    <%- if p('span_storage_type') == 'badger' %>
    additional_volumes:
    - path: /var/vcap/store/jaeger-all-in-one/keys
      writable: true
    - path: /var/vcap/store/jaeger-all-in-one/values
      writable: true
    <%- end %>

    args:
    - --admin-http-port=14269
    <%- flags.each do |flag| -%>
    - <%= flag %>
    <%- end -%>